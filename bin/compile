#!/bin/sh
set -e
echo "==> Setting up PostgreSQL focal archive APT source"

# 1. Remove old PGDG list if present
if [ -f /etc/apt/sources.list.d/pgdg.list ]; then
  grep -q 'apt.postgresql.org' /etc/apt/sources.list.d/pgdg.list && rm -f /etc/apt/sources.list.d/pgdg.list
fi

# 2. Install minimal prerequisites quietly
apt-get update -qq
DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends curl ca-certificates

# 3. Import PGDG signing key
mkdir -p /usr/share/postgresql-common/pgdg
curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc \
  -o /usr/share/postgresql-common/pgdg/apt.postgresql.org.asc

# 4. Point to the archived focal repository
cat <<EOF > /etc/apt/sources.list.d/pgdg.list
deb [signed-by=/usr/share/postgresql-common/pgdg/apt.postgresql.org.asc] https://apt-archive.postgresql.org/pub/repos/apt focal-pgdg-archive main
EOF

# 5. Refresh APT metadata
rm -rf /var/lib/apt/lists/*
apt-get update -qq